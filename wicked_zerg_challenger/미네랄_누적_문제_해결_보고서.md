# 미네랄 누적 문제 해결 보고서

## 📋 문제 개요
미네랄이 1000개 이상 쌓이는 문제가 발생했습니다. 이는 봇이 자원을 제대로 소비하지 못하고 있다는 의미입니다.

---

## 🔍 문제 원인 분석

### 1. **`_emergency_mineral_flush()` 함수의 조건 제한**

**위치**: `production_manager.py` - `_emergency_mineral_flush()` 함수

**원인**:
- 미네랄이 1000개 이상일 때 호출되지만, 여러 조건들이 있어서 실행되지 않을 수 있음
- 조건이 맞지 않으면 `False`를 반환하고 미네랄이 계속 쌓임

**문제 시나리오**:
```
1. 미네랄 1000개 이상
2. _emergency_mineral_flush() 호출
3. Priority 1: 기술 건물 건설 - 이미 건설되어 있음 → 스킵
4. Priority 2: 매크로 해처리 - 라바가 3개 이상 → 스킵
5. Priority 3: 기술 유닛 생산 - 기술 건물이 준비되지 않음 → 스킵
6. Priority 4: 저글링 생산 - 산란못이 준비되지 않음 → 스킵
7. False 반환 → 미네랄 계속 쌓임
```

### 2. **라바 부족 시 매크로 해처리 건설 조건이 너무 엄격**

**원인**:
- 라바가 3개 이상이면 매크로 해처리를 건설하지 않음
- 하지만 미네랄이 1500개 이상이면 라바가 많아도 더 많은 라바가 필요할 수 있음

### 3. **대체 소비 수단 부족**

**원인**:
- 모든 조건이 맞지 않을 때 대체 수단이 없음
- 대군주 생산, 방어 건물 건설 등 추가 옵션이 없음

---

## ✅ 해결 방법

### 1. **매크로 해처리 건설 조건 완화**

미네랄이 매우 높을 때(1500+)는 라바 개수와 관계없이 매크로 해처리를 건설하도록 수정:

```python
# 수정 전
if larva_count < 3 and b.can_afford(UnitTypeId.HATCHERY):
    # Build macro hatchery

# 수정 후
should_build_hatchery = (
    (larva_count < 3 and b.minerals >= 600) or  # Larva shortage
    (b.minerals >= 1500)  # Very high minerals - need more larva production
)
if should_build_hatchery and b.can_afford(UnitTypeId.HATCHERY):
    # Build macro hatchery
```

### 2. **추가 우선순위 추가**

모든 조건이 맞지 않을 때를 대비해 추가 우선순위를 추가:

#### Priority 5: 대군주 생산
- 인구수 블록을 해제하여 병력 생산 가능하게 함
- 미네랄이 1500+일 때는 여러 대군주를 한 번에 생산

```python
# Priority 5: CRITICAL - If nothing else worked, produce Overlords
if b.can_afford(UnitTypeId.OVERLORD) and larvae.exists:
    overlords_to_produce = min(3, len(larvae)) if b.minerals >= 1500 else 1
    # Produce overlords to unlock supply
```

#### Priority 6: 매크로 해처리 강제 건설
- 미네랄이 1500+일 때는 라바 개수와 관계없이 건설

```python
# Priority 6: Build Macro Hatchery even if larva count is higher
if b.minerals >= 1500 and b.can_afford(UnitTypeId.HATCHERY):
    # Build macro hatchery
```

#### Priority 7: 방어 건물 건설
- 모든 수단이 실패했을 때 최후의 수단
- 가시촉수를 건설하여 미네랄 소비

```python
# Priority 7: Build static defense (Spine Crawlers)
if b.minerals >= 1000 and b.structures(UnitTypeId.SPAWNINGPOOL).ready.exists:
    if b.can_afford(UnitTypeId.SPINECRAWLER):
        # Build spine crawlers for defense
```

---

## 📝 수정된 파일

### `production_manager.py`
- `_emergency_mineral_flush()` 함수에 추가 우선순위 3개 추가
- 매크로 해처리 건설 조건 완화
- 대군주 생산, 방어 건물 건설 등 대체 수단 추가

---

## 🎯 예상 효과

### 수정 전:
```
미네랄 1000+ → 조건 불일치 → False 반환 → 미네랄 계속 쌓임 → 2000+ → 3000+ ...
```

### 수정 후:
```
미네랄 1000+ → Priority 1-4 시도 → 실패 시
→ Priority 5: 대군주 생산 → 인구수 해제 → 병력 생산 가능
→ Priority 6: 매크로 해처리 건설 → 라바 증가 → 병력 생산 증가
→ Priority 7: 방어 건물 건설 → 미네랄 소비
```

### 구체적인 개선 사항:

1. **대체 수단 확보**
   - 모든 조건이 맞지 않아도 대군주 생산, 해처리 건설, 방어 건물 건설 등으로 미네랄 소비

2. **조건 완화**
   - 미네랄이 매우 높을 때(1500+)는 조건을 완화하여 더 적극적으로 소비

3. **인구수 블록 해제**
   - 대군주 생산을 통해 인구수 블록을 해제하여 병력 생산 가능하게 함

---

## 📊 로그 메시지

수정 후 다음과 같은 로그 메시지가 나타납니다:

```
[EMERGENCY FLUSH] [120s] Produced 3 Overlords to unlock supply (minerals: 1500)
[EMERGENCY FLUSH] [180s] Building Macro Hatchery (minerals: 1600, larvae: 5)
[EMERGENCY FLUSH] [240s] Building Spine Crawler (minerals: 1200)
```

이 메시지들은 미네랄이 소비되고 있음을 알려줍니다.

---

## 🔄 다음 단계

1. **게임 테스트**: 수정된 로직이 정상 작동하는지 확인
2. **로그 모니터링**: 미네랄 소비 메시지가 적절히 나타나는지 확인
3. **미네랄 추적**: 게임 중 미네랄이 1000개 이상 쌓이지 않는지 확인

---

## 💡 추가 권장 사항

1. **자원 소비 우선순위 명확화**
   - 병력 생산 > 건물 건설 > 업그레이드 순서로 명확히 정의

2. **라바 생산 최적화**
   - 미네랄이 높을 때는 매크로 해처리를 더 적극적으로 건설

3. **인구수 관리 강화**
   - 미네랄이 높을 때는 대군주를 미리 생산하여 인구수 블록 방지

---

**작성일**: 2026-01-15  
**수정 파일**: `wicked_zerg_challenger/production_manager.py`
