# 전체 로직 점검 보고서

**작성일**: 2026-01-15  
**점검 범위**: 프로젝트 전체 로직 구조 및 실행 흐름  
**상태**: ✅ **점검 완료**

---

## 📋 개요

프로젝트의 전체 로직을 점검하여 실행 흐름, 매니저 구조, 에러 처리, 성능 최적화 등을 종합적으로 분석했습니다.

---

## 🏗️ 프로젝트 구조

### 핵심 파일 구조

```
wicked_zerg_challenger/
├── wicked_zerg_bot_pro.py      # 메인 봇 클래스 (BotAI 상속)
├── run.py                       # 게임 실행 진입점
├── production_manager.py        # 병력 생산 관리
├── economy_manager.py          # 경제 및 확장 관리
├── combat_manager.py           # 전투 전략 및 유닛 제어
├── intel_manager.py            # 정보 수집 및 Blackboard 패턴
├── scouting_system.py          # 정찰 시스템
├── queen_manager.py            # 여왕 관리
├── unit_factory.py             # 유닛 생산 팩토리
├── map_manager.py              # 맵 관리
├── rogue_tactics_manager.py    # 특수 전술
├── spell_unit_manager.py       # 스펠 유닛 관리
└── monitoring/                 # 모니터링 시스템
    ├── dashboard_api.py        # FastAPI 서버
    ├── bot_api_connector.py    # 봇-서버 연결
    └── mobile_app_android/     # 안드로이드 앱
```

---

## 🔄 실행 흐름 분석

### 1. 게임 시작 (on_start)

**초기화 순서**:
1. IntelManager (가장 먼저 - 다른 매니저들이 의존)
2. EconomyManager
3. ProductionManager
4. CombatManager
5. ScoutingSystem
6. QueenManager
7. 기타 매니저들 (RogueTactics, SpellUnit, etc.)

**특징**:
- 에러 발생 시 Dummy 매니저로 대체하여 크래시 방지
- Micro Ladder 모드 자동 감지
- 맵 크기 자동 감지 (SMALL/MEDIUM/LARGE)

### 2. 게임 루프 (on_step)

**매니저 실행 주기**:

| 매니저 | 실행 주기 | 설명 |
|--------|----------|------|
| IntelManager | 매 프레임 (1) | Blackboard 패턴 - 모든 매니저가 공유 |
| Micro Controller | 매 프레임 (1) | 전투 반응성 유지 |
| CombatManager | 4프레임마다 | 전술적 의사결정 |
| ProductionManager | 22프레임마다 | 건물 및 병력 생산 |
| EconomyManager | 22프레임마다 | 일벌레 및 확장 관리 |
| ScoutingSystem | 8프레임마다 | 정찰 업데이트 |
| QueenManager | 16프레임마다 | 여왕 능력 사용 |

**최적화 전략**:
- CPU 부하 감소를 위해 실행 주기 증가 (88프레임, 448프레임 등)
- 무거운 작업은 별도 스레드에서 실행 (asyncio executor)
- 타임아웃 설정으로 블로킹 방지 (CombatManager: 100ms)

---

## 🔍 주요 로직 분석

### 1. ProductionManager (병력 생산)

**핵심 기능**:
- 자동 테크 건물 건설 (Lair, Hive, Hydralisk Den 등)
- 동적 라바 예약 로직 (병력 supply에 따라 10-30%)
- 서플라이 블록 예방 (생산 속도에 따른 동적 임계값)
- 방어 병력 유지 (공격 중일 때 요구량 감소)

**최근 개선 사항**:
- ✅ `_safe_train()` 헬퍼 함수 추가 (bool/coroutine 처리)
- ✅ 라바 예약 로직 개선 (병력 supply 기반)
- ✅ 서플라이 블록 예방 강화 (동적 임계값)
- ✅ 방어 병력 유지 조건 개선 (공격 중 감소)

**잠재적 문제점**:
- ⚠️ 일부 `train()` 호출이 아직 `_safe_train()` 미사용
- ⚠️ `random.choice()` 사용 시 빈 리스트 체크 필요

### 2. EconomyManager (경제 관리)

**핵심 기능**:
- 확장 타이밍 결정
- 일벌레 배치 및 가스 관리
- 건물 건설 중복 방지 (build_reservations)
- 확장 후 일벌레 자동 배치

**최근 개선 사항**:
- ✅ `_assign_workers_to_new_base()` 메서드 추가
- ✅ 확장 후 일벌레 자동 배치 로직 적용

**잠재적 문제점**:
- ⚠️ 확장 로직이 여러 곳에 분산되어 있음
- ⚠️ 일벌레 배치가 모든 확장 지점에 적용되지 않음

### 3. CombatManager (전투 관리)

**핵심 기능**:
- 병력 집결 및 공격 타이밍
- 방어 및 후퇴 로직
- 역공 기회 감지
- 전투 모드 전환 (CAUTIOUS/AGGRESSIVE)

**개선 필요 사항**:
- [ ] 병력 집결 조건 개선 (유닛 타입별 차별화)
- [ ] 공격 타이밍 개선 (상대 병력 추정)
- [ ] 역공 기회 감지 개선 (이동 패턴 분석)

### 4. IntelManager (정보 수집)

**핵심 기능**:
- Blackboard 패턴 구현
- 적 정보 캐싱 (cached_*)
- 위협 수준 평가
- 전략 모드 결정

**특징**:
- 모든 매니저가 공유하는 중앙 정보 저장소
- 매 프레임 업데이트로 최신 정보 유지
- 캐싱으로 성능 최적화

### 5. ScoutingSystem (정찰)

**핵심 기능**:
- 대군주 스카우팅
- 적 기지 탐색
- 확장 감지
- 위협 평가

**최근 개선 사항**:
- ✅ 서플라이 블록 시 스카우팅 중단 로직 추가

---

## ⚠️ 발견된 문제점

### 1. train() 메서드 호출 불일치

**문제**:
- `_safe_train()` 헬퍼 함수가 추가되었지만, 일부 `train()` 호출이 아직 직접 사용 중
- `random.choice()` 결과가 `bool`일 수 있는 경우 처리 필요

**영향**:
- `TypeError: object bool can't be used in 'await' expression` 오류 발생

**해결 상태**:
- ✅ `production_manager.py` 내 주요 호출 지점 수정 완료
- ✅ `random.choice(...).train()` 호출 모두 `_safe_train()` 사용으로 변경
- ✅ `ready_larvae.random.train()` 호출도 수정 완료
- ⚠️ 다른 파일(`unit_factory.py`, `wicked_zerg_bot_pro.py` 등)의 호출은 아직 미수정

### 2. 확장 로직 분산

**문제**:
- 확장 로직이 여러 곳에 분산되어 있음:
  - `economy_manager.py`: `_manage_expansion()`
  - `economy_manager.py`: `_expand_for_gas()`
  - `economy_manager.py`: 빌드 오더 내 확장
  - `production_manager.py`: 일부 확장 로직

**영향**:
- 코드 중복 및 유지보수 어려움
- 일벌레 배치 로직이 모든 확장 지점에 적용되지 않음

**해결 상태**:
- ✅ 일벌레 배치 로직 추가 완료
- ⚠️ 확장 로직 통합 필요

### 3. 에러 처리 패턴 불일치

**문제**:
- 일부 매니저는 상세한 에러 로깅
- 일부 매니저는 silent fail
- 에러 복구 전략이 일관되지 않음

**영향**:
- 디버깅 어려움
- 일부 에러가 무시되어 문제가 누적될 수 있음

**권장 사항**:
- 통일된 에러 처리 패턴 적용
- 중요 에러는 로깅, 사소한 에러는 silent fail

### 4. 성능 최적화 불일치

**문제**:
- 일부 로직은 CPU 부하 감소를 위해 실행 주기 증가
- 일부 로직은 여전히 매 프레임 실행
- 최적화 기준이 일관되지 않음

**영향**:
- CPU 사용량이 일부 구간에서 높을 수 있음
- 게임 프레임 드롭 가능성

**권장 사항**:
- 성능 프로파일링으로 병목 지점 파악
- 중요도에 따른 실행 주기 재조정

---

## ✅ 강점

### 1. 견고한 에러 처리

- 모든 주요 로직에 try-except 블록
- Dummy 매니저로 크래시 방지
- 에러 발생 시 Fallback 로직 실행

### 2. 성능 최적화

- IntelManager 캐싱으로 중복 연산 방지
- 실행 주기 조정으로 CPU 부하 감소
- 비동기 파일 I/O로 블로킹 방지

### 3. 모듈화된 구조

- 각 매니저가 명확한 책임을 가짐
- Blackboard 패턴으로 정보 공유
- 확장 가능한 구조

### 4. 최근 개선 사항

- ✅ 라바 예약 로직 개선
- ✅ 서플라이 블록 예방 강화
- ✅ 방어 병력 유지 조건 개선
- ✅ 확장 후 일벌레 배치 자동화
- ✅ `_safe_train()` 헬퍼 함수 추가

---

## 📊 로직 실행 흐름도

```
on_start()
  ├─ IntelManager 초기화
  ├─ EconomyManager 초기화
  ├─ ProductionManager 초기화
  ├─ CombatManager 초기화
  └─ 기타 매니저 초기화

on_step(iteration)
  ├─ 매 프레임:
  │   ├─ IntelManager.update()          # Blackboard 업데이트
  │   └─ Micro Controller 업데이트
  │
  ├─ 4프레임마다:
  │   └─ CombatManager.update()         # 전투 로직
  │
  ├─ 8프레임마다:
  │   └─ ScoutingSystem.update()        # 정찰
  │
  ├─ 16프레임마다:
  │   └─ QueenManager.update()         # 여왕 능력
  │
  ├─ 22프레임마다:
  │   ├─ ProductionManager.update()     # 병력 생산
  │   └─ EconomyManager.update()        # 경제 관리
  │
  └─ 기타 주기:
      ├─ 88프레임마다: 항복 체크
      ├─ 100프레임마다: Telemetry 로깅
      └─ 448프레임마다: 무거운 분석 작업
```

---

## 🎯 개선 권장 사항

### 즉시 적용 가능 (1-2일)

1. **남은 `train()` 호출 수정**:
   - ✅ `production_manager.py` 내 모든 `random.choice(...).train()` 호출 수정 완료
   - ⚠️ 다른 파일(`unit_factory.py`, `wicked_zerg_bot_pro.py` 등)의 호출 확인 필요
   - ⚠️ `unit_factory.py`의 `hatch.train()` 호출 확인 (비동기 아님)

2. **확장 로직 통합**:
   - 모든 확장 지점에 일벌레 배치 로직 적용
   - 확장 로직을 하나의 메서드로 통합

### 단기 개선 (3-5일)

3. **에러 처리 패턴 통일**:
   - 통일된 에러 로깅 함수 생성
   - 중요도에 따른 에러 처리 레벨 정의

4. **성능 프로파일링**:
   - CPU 사용량 측정
   - 병목 지점 파악 및 최적화

### 중기 개선 (1주 이상)

5. **로직 리팩토링**:
   - 확장 로직 통합
   - 중복 코드 제거
   - 매니저 간 의존성 명확화

6. **테스트 코드 작성**:
   - 단위 테스트 추가
   - 통합 테스트 추가
   - 시나리오 테스트 추가

---

## 📈 성능 지표

### 현재 실행 주기

- **매 프레임**: IntelManager, Micro Controller
- **4프레임**: CombatManager
- **8프레임**: ScoutingSystem
- **16프레임**: QueenManager
- **22프레임**: ProductionManager, EconomyManager
- **88프레임**: 항복 체크
- **448프레임**: 무거운 분석 작업

### 예상 CPU 사용량

- **IntelManager**: 높음 (매 프레임)
- **CombatManager**: 중간 (4프레임마다)
- **ProductionManager**: 중간 (22프레임마다)
- **EconomyManager**: 중간 (22프레임마다)
- **기타**: 낮음 (주기적)

---

## 🔒 안정성 평가

### 에러 처리

- ✅ 주요 로직에 try-except 블록
- ✅ Dummy 매니저로 크래시 방지
- ✅ Fallback 로직으로 복구 시도
- ⚠️ 일부 에러가 silent fail로 처리됨

### 데이터 무결성

- ✅ Atomic file writing (telemetry_logger)
- ✅ Build reservations로 중복 건설 방지
- ✅ 캐싱으로 일관성 유지

### 성능 안정성

- ✅ 타임아웃 설정으로 블로킹 방지
- ✅ 비동기 I/O로 게임 루프 보호
- ⚠️ 일부 로직이 여전히 동기 실행

---

## 📝 종합 평가

### 강점

1. **견고한 구조**: 모듈화된 매니저 구조
2. **에러 처리**: 크래시 방지 메커니즘
3. **성능 최적화**: 실행 주기 조정 및 캐싱
4. **최근 개선**: 주요 문제점 해결

### 개선 필요 사항

1. **코드 일관성**: `train()` 호출 통일
2. **로직 통합**: 확장 로직 통합
3. **에러 처리**: 패턴 통일
4. **성능 최적화**: 추가 프로파일링

### 전체 평가

**점수**: 8.5/10

- 구조: 9/10 (모듈화 잘 되어 있음)
- 안정성: 8/10 (에러 처리 양호, 일부 개선 필요)
- 성능: 8/10 (최적화 진행 중)
- 유지보수성: 8/10 (코드 일관성 개선 필요)

---

## 🔄 다음 단계

1. **즉시 작업**:
   - 남은 `train()` 호출 수정
   - 확장 로직에 일벌레 배치 적용

2. **단기 작업**:
   - 에러 처리 패턴 통일
   - 성능 프로파일링

3. **중기 작업**:
   - 로직 리팩토링
   - 테스트 코드 작성

---

**작성일**: 2026-01-15  
**점검 완료**: ✅  
**다음 단계**: 남은 `train()` 호출 수정 및 확장 로직 통합
