# 상위 테크 건물 및 여왕 작업 문제 해결 보고서

## 📋 문제 개요
봇이 상위 테크 건물을 건설하지 않고, 여왕이 일을 하지 않으며, 상위 테크 유닛을 생산하지 않는 문제가 발생했습니다.

---

## 🔍 발견된 주요 문제들

### 1. **상위 테크 건물 건설 우선순위 문제**

**위치**: `production_manager.py` - `_autonomous_tech_progression()` 함수

**원인**:
- `tech_priority_score`가 `production_priority_score * 0.8`보다 높아야 건설 모드로 전환
- 하지만 `production_priority_score`가 항상 높게 계산되어 테크 건물 건설이 차단됨
- Lair가 Hydralisk Den보다 낮은 우선순위로 계산됨 (40.0 vs 45.0)

**문제 시나리오**:
```
1. 게임 시작
2. tech_priority_score = 40.0 (Lair 필요)
3. production_priority_score = 70.0 (병력 생산 필요)
4. 40.0 < 70.0 * 0.8 = 56.0
5. CONSTRUCTION 모드로 전환 안 됨
6. 테크 건물 건설 안 됨
```

### 2. **Hydralisk Den 건설 조건 문제**

**원인**:
- Hydralisk Den은 Lair가 **필수**인데, 코드에서는 "권장"으로만 표시됨
- Lair 없이 Hydralisk Den을 건설하려고 시도할 수 있음
- 하지만 Lair 없이는 Hydralisk를 생산할 수 없음

**문제 시나리오**:
```
1. Hydralisk Den 건설 (Lair 없이)
2. Hydralisk Den 완성
3. Hydralisk 생산 시도
4. Lair가 없어서 생산 불가
5. 상위 테크 유닛 생산 실패
```

### 3. **Lair/Hive 업그레이드 조건이 너무 엄격함**

**원인**:
- Lair 업그레이드: `time > 120` AND `has_gas_income` AND `can_afford`
- Hive 업그레이드: `time > 240` AND `has_gas_income` AND `can_afford`
- 미네랄이 1000+일 때도 시간 조건 때문에 업그레이드 안 됨

### 4. **여왕 라바 주입 로직 문제**

**원인**:
- 여왕이 라바가 100개 이상일 때만 주입을 스킵
- 하지만 여왕이 다른 작업(크리핑 확산 등)에 바쁘면 주입을 못할 수 있음
- 주입 로직이 `for queen in queen_list` 루프 안에 있어서 각 여왕마다 체크함

---

## ✅ 해결 방법

### 1. **테크 우선순위 점수 개선**

Lair를 최우선으로 설정하고, Hydralisk Den은 Lair가 있을 때만 높은 점수:

```python
# 수정 전
if not b.structures(UnitTypeId.HYDRALISKDEN).exists and b.time > 180:
    score += 45.0
if not b.structures(UnitTypeId.LAIR).exists and b.time > 120:
    score += 40.0

# 수정 후
# CRITICAL: Lair must be built FIRST before other T2 buildings
if not b.structures(UnitTypeId.LAIR).exists and b.time > 120:
    score += 60.0  # Increased from 40.0 - Lair is highest priority
# CRITICAL: Hydralisk Den requires Lair - only score if Lair exists
has_lair = b.structures(UnitTypeId.LAIR).exists or b.structures(UnitTypeId.HIVE).exists
if not b.structures(UnitTypeId.HYDRALISKDEN).exists and has_lair and b.time > 180:
    score += 55.0  # Higher priority when Lair exists
elif not b.structures(UnitTypeId.HYDRALISKDEN).exists and not has_lair:
    score += 20.0  # Lower priority when Lair doesn't exist
```

### 2. **Hydralisk Den 전제 조건 강화**

Lair가 필수임을 명확히 하고, Lair 없이는 건설하지 않도록 수정:

```python
# 수정 전
# Hydralisk Den: no prerequisites (but Lair is recommended for better units)

# 수정 후
# CRITICAL: Hydralisk Den REQUIRES Lair (not optional!)
if tid == UnitTypeId.HYDRALISKDEN:
    has_lair = b.structures(UnitTypeId.LAIR).exists or b.structures(UnitTypeId.HIVE).exists
    if not has_lair and b.already_pending(UnitTypeId.LAIR) == 0:
        # Lair is required - skip Hydralisk Den until Lair is built
        continue
```

### 3. **테크 건설 모드 전환 조건 완화**

미네랄이 높을 때는 더 적극적으로 테크 건물을 건설하도록 수정:

```python
# 수정 전
if self.tech_priority_score > self.production_priority_score * 0.8:
    self.current_mode = "CONSTRUCTION"

# 수정 후
minerals_very_high = b.minerals >= 1000
if minerals_very_high:
    threshold_multiplier = 0.5  # Much lower threshold
else:
    threshold_multiplier = 0.7  # Lowered from 0.8

if self.tech_priority_score > self.production_priority_score * threshold_multiplier:
    self.current_mode = "CONSTRUCTION"
```

### 4. **Lair/Hive 업그레이드 조건 완화**

미네랄이 높을 때는 시간 조건을 완화:

```python
# 수정 전
if (
    spawning_pools
    and hatcheries
    and not lairs
    and b.already_pending(UnitTypeId.LAIR) == 0
    and b.time > 120
    and has_gas_income
    and b.can_afford(UnitTypeId.LAIR)
):

# 수정 후
minerals_very_high = b.minerals >= 1000
if minerals_very_high:
    has_gas_income = extractors.exists and b.vespene >= 30  # Lower threshold

if (
    spawning_pools
    and hatcheries
    and not lairs
    and b.already_pending(UnitTypeId.LAIR) == 0
    and (b.time > 120 or minerals_very_high)  # Lower time threshold OR minerals high
    and (has_gas_income or minerals_very_high)  # More lenient gas check
    and b.can_afford(UnitTypeId.LAIR)
):
```

### 5. **여왕 라바 주입 로직 개선**

라바 주입을 더 적극적으로 수행하도록 수정:

```python
# 수정 전
for queen in queen_list:
    if current_larva_count > 100:
        continue  # Skip inject
    ready_queens = [q for q in queen_list if q.energy >= 25]
    # ... inject logic

# 수정 후
# CRITICAL: Always inject larva unless we have excessive larvae
current_larva_count = self.bot.units(UnitTypeId.LARVA).amount
should_skip_inject = current_larva_count > 100

if not should_skip_inject:
    ready_queens = [q for q in queen_list if q.is_ready and q.energy >= 25]
    # ... inject logic
```

---

## 📝 수정된 파일

### `production_manager.py`
- `_calculate_tech_priority_score()` 함수: Lair 우선순위 증가, Hydralisk Den 조건 개선
- `_autonomous_tech_progression()` 함수: Hydralisk Den 전제 조건 강화, 테크 건설 모드 전환 조건 완화
- Lair/Hive 업그레이드 조건 완화 (미네랄 높을 때)

### `queen_manager.py`
- `manage_queens()` 함수: 라바 주입 로직 개선

---

## 🎯 예상 효과

### 수정 전:
```
tech_priority_score = 40.0, production_priority_score = 70.0
→ 40.0 < 70.0 * 0.8 = 56.0
→ CONSTRUCTION 모드로 전환 안 됨
→ 테크 건물 건설 안 됨
```

### 수정 후:
```
tech_priority_score = 60.0 (Lair), production_priority_score = 70.0
→ 60.0 > 70.0 * 0.7 = 49.0 (또는 0.5 = 35.0 if minerals >= 1000)
→ CONSTRUCTION 모드로 전환
→ Lair 건설 시작
→ 이후 Hydralisk Den 건설 가능
```

### 구체적인 개선 사항:

1. **Lair 우선순위 증가**
   - Lair가 가장 높은 우선순위를 가짐 (60.0)
   - Lair 없이는 다른 T2 건물이 제대로 작동하지 않음

2. **Hydralisk Den 전제 조건 강화**
   - Lair가 필수임을 명확히 함
   - Lair 없이는 Hydralisk Den을 건설하지 않음

3. **테크 건설 모드 전환 개선**
   - 미네랄이 높을 때(1000+)는 더 적극적으로 테크 건물 건설
   - threshold_multiplier를 0.5로 낮춤

4. **Lair/Hive 업그레이드 개선**
   - 미네랄이 높을 때는 시간 조건 완화
   - 가스 조건도 완화

5. **여왕 라바 주입 개선**
   - 라바가 100개 이하일 때는 항상 주입 시도
   - 주입 로직을 더 명확하게 분리

---

## 📊 로그 메시지

수정 후 다음과 같은 로그 메시지가 나타납니다:

```
[AUTONOMOUS] [120s] Tech:60.0 Prod:70.0 Mode:CONSTRUCTION
[TECH PROGRESSION] [120s] Upgrading Hatchery to Lair (unlocks T2 units)
[AUTONOMOUS TECH] [180s] Building HYDRALISKDEN (Tech Score: 55.0 > Production Score: 70.0)
[SUCCESS] 라바 주입 성공! 여왕 에너지: 25
```

---

## 🔄 다음 단계

1. **게임 테스트**: 수정된 로직이 정상 작동하는지 확인
2. **로그 모니터링**: 테크 건물 건설 및 여왕 작업 메시지 확인
3. **상위 테크 유닛 생산 확인**: Lair와 Hydralisk Den이 건설된 후 Hydralisk 생산 확인

---

## 💡 추가 권장 사항

1. **가스 수집 최적화**
   - Lair 업그레이드에 필요한 가스를 확보하기 위해 추출장 건설 우선순위 증가

2. **여왕 생산 우선순위**
   - 해처리당 1명의 여왕을 확보하여 라바 주입 지속

3. **테크 건물 건설 순서**
   - Lair → Hydralisk Den → Spire 순서로 건설
   - 전제 조건을 명확히 확인

---

**작성일**: 2026-01-15  
**수정 파일**: 
- `wicked_zerg_challenger/production_manager.py`
- `wicked_zerg_challenger/queen_manager.py`
