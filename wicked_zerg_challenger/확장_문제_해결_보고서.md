# 확장 문제 해결 보고서

## 📋 문제 개요
봇이 확장(expansion)을 하지 않는 문제가 발생했습니다. 미네랄이 1000개 이상 쌓여도 확장을 하지 않아 경제력이 제한되고 있습니다.

---

## 🔍 문제 원인 분석

### 1. **확장 조건이 너무 엄격함**

**위치**: `economy_manager.py` - `_manage_expansion()` 함수

**원인**:
- 첫 번째 확장 조건이 너무 엄격함:
  - 일벌레 16+ AND 병력 10+ AND 미네랄 300+ 모두 만족해야 함
  - 저글링 8+ AND 여왕 1+ AND 가시촉수 1+ 모두 있어야 함
- 이러한 조건들이 모두 맞지 않으면 확장을 하지 않음

**문제 시나리오**:
```
1. 미네랄 1000+ 쌓임
2. _manage_expansion() 호출
3. 첫 번째 확장 조건 체크:
   - 일벌레 16+ ✓
   - 병력 10+ ✗ (병력이 부족)
   - 저글링 8+ ✗ (저글링이 부족)
   - 여왕 1+ ✗ (여왕이 없음)
   - 가시촉수 1+ ✗ (가시촉수가 없음)
4. 조건 불일치 → 확장 안 함
5. 미네랄 계속 쌓임
```

### 2. **긴급 확장 조건이 너무 높음**

**원인**:
- 긴급 확장 조건이 미네랄 1500+로 설정되어 있음
- 미네랄이 1000~1500 사이일 때는 확장을 하지 않음

### 3. **확장 위치 체크가 너무 엄격함**

**원인**:
- `expansion_locations`가 없으면 바로 `return`
- 하지만 `expand_now()` 함수가 자동으로 확장 위치를 찾을 수 있음

---

## ✅ 해결 방법

### 1. **긴급 확장 조건 완화**

미네랄 1000+일 때도 긴급 확장을 하도록 수정:

```python
# 수정 전
emergency_expand_mineral_threshold = 1500

# 수정 후
emergency_expand_mineral_threshold = 1000  # Lowered from 1500
```

### 2. **방어 조건 완화**

미네랄이 매우 높을 때(1000+)는 방어 조건을 완화:

```python
# 수정 전
if current_base_count == 1:
    if zergling_count < 8:
        return
    if queen_count < 1:
        return
    if len(spine_crawlers) < 1:
        return

# 수정 후
minerals_very_high = b.minerals >= 1000
if current_base_count == 1:
    if not minerals_very_high:
        # Only check defense requirements when minerals are not very high
        if zergling_count < 8:
            return
        # ... other checks
```

### 3. **확장 위치 체크 완화**

확장 위치가 없어도 미네랄이 높으면 확장 시도:

```python
# 수정 전
if not expansion_locations:
    return  # Skip expansion

# 수정 후
if not expansion_locations_available and b.minerals < 1000:
    # Only skip if minerals are low AND no expansion locations
    pass  # Continue to check other conditions
```

### 4. **첫 번째 확장 조건 완화**

미네랄이 높을 때(800+)는 조건을 완화:

```python
# 수정 후
if current_base_count == 1:
    minerals_high = b.minerals >= 800
    if minerals_high:
        # When minerals are high, only check if we can afford it
        if b.can_afford(UnitTypeId.HATCHERY):
            await b.expand_now()
            return
    elif (worker_count >= 16 and army_supply >= 10 and b.minerals >= 300):
        # Normal conditions
        await b.expand_now()
        return
```

---

## 📝 수정된 파일

### `economy_manager.py`
- `_manage_expansion()` 함수의 조건 완화
- 긴급 확장 조건 1500 → 1000으로 낮춤
- 미네랄이 높을 때 방어 조건 완화
- 확장 위치 체크 완화
- 첫 번째 확장 조건 완화

---

## 🎯 예상 효과

### 수정 전:
```
미네랄 1000+ → 조건 불일치 → 확장 안 함 → 미네랄 계속 쌓임 → 1500+ → 긴급 확장
```

### 수정 후:
```
미네랄 1000+ → 긴급 확장 조건 만족 → 즉시 확장
미네랄 800+ → 첫 번째 확장 조건 완화 → 확장
미네랄 1000+ → 방어 조건 완화 → 확장
```

### 구체적인 개선 사항:

1. **조건 완화**
   - 미네랄이 높을 때는 방어 조건을 완화하여 더 적극적으로 확장

2. **긴급 확장 개선**
   - 미네랄 1000+일 때도 긴급 확장을 하도록 개선

3. **확장 위치 처리 개선**
   - 확장 위치가 없어도 `expand_now()`가 자동으로 처리하도록 개선

---

## 📊 로그 메시지

수정 후 다음과 같은 로그 메시지가 나타납니다:

```
[EXPANSION] [120s] Emergency expansion: 1000 minerals (resource expenditure)
[EXPANSION] [180s] First expansion (high minerals: 850)
```

이 메시지들은 확장이 실행되고 있음을 알려줍니다.

---

## 🔄 다음 단계

1. **게임 테스트**: 수정된 로직이 정상 작동하는지 확인
2. **로그 모니터링**: 확장 메시지가 적절히 나타나는지 확인
3. **확장 추적**: 게임 중 확장이 적절한 타이밍에 이루어지는지 확인

---

## 💡 추가 권장 사항

1. **확장 타이밍 최적화**
   - 게임 시간과 자원 상태를 고려한 최적의 확장 타이밍 결정

2. **방어와 확장의 균형**
   - 방어가 충분하지 않아도 확장할 수 있도록 하되, 확장 후 방어 강화

3. **확장 위치 선택**
   - 가장 가까운 확장 위치를 우선 선택하여 빠른 자원 수집

---

**작성일**: 2026-01-15  
**수정 파일**: `wicked_zerg_challenger/economy_manager.py`
